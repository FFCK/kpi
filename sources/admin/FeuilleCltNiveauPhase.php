<?phpinclude_once('../commun/MyPage.php');include_once('../commun/MyBdd.php');include_once('../commun/MyTools.php');require('../fpdf/fpdf.php');// Gestion de la Feuille de Classement par Journeeclass FeuilleCltNiveauPhase extends MyPage {    function FeuilleCltNiveauPhase() {        MyPage::MyPage();        $myBdd = new MyBdd();        $codeCompet = utyGetSession('codeCompet', '');        //Saison        $codeSaison = utyGetSaison();        $titreDate = "Saison " . $codeSaison;        $arrayCompetition = $myBdd->GetCompetition($codeCompet, $codeSaison);        $titreCompet = 'Compétition : ' . $arrayCompetition['Libelle'] . ' (' . $codeCompet . ')';        $qualif = $arrayCompetition['Qualifies'];        $elim = $arrayCompetition['Elimines'];        $visuels = utyGetVisuels($arrayCompetition, TRUE);        // Langue        $langue = parse_ini_file("../commun/MyLang.ini", true);        if (isset($_GET['lang']) && $_GET['lang'] == 'en') {            $arrayCompetition['En_actif'] = 'O';        } elseif (isset($_GET['lang']) && $_GET['lang'] == 'fr') {            $arrayCompetition['En_actif'] = '';        }        if ($arrayCompetition['En_actif'] == 'O') {            $lang = $langue['en'];        } else {            $lang = $langue['fr'];        }        //Création        $pdf = new FPDF('P');        $pdf->Open();        $pdf->SetTitle("Classement par phase");        $pdf->SetAuthor("kayak-polo.info");        $pdf->SetCreator("kayak-polo.info");        $pdf->AddPage();        if ($arrayCompetition['Sponsor_actif'] == 'O' && isset($visuels['sponsor'])) {            $pdf->SetAutoPageBreak(true, 30);        } else {            $pdf->SetAutoPageBreak(true, 15);        }        // Bandeau        if ($arrayCompetition['Bandeau_actif'] == 'O' && isset($visuels['bandeau'])) {            $img = redimImage($visuels['bandeau'], 210, 10, 16, 'C');            $pdf->Image($img['image'], $img['positionX'], 8, 0, $img['newHauteur']);            // KPI + Logo            } elseif ($arrayCompetition['Kpi_ffck_actif'] == 'O' && $arrayCompetition['Logo_actif'] == 'O' && isset($visuels['logo'])) {            $pdf->Image('../img/logoKPI-small.jpg', 10, 10, 0, 16, 'jpg', "https://www.kayak-polo.info");            $img = redimImage($visuels['logo'], 210, 10, 16, 'R');            $pdf->Image($img['image'], $img['positionX'], 8, 0, $img['newHauteur']);            // KPI        } elseif ($arrayCompetition['Kpi_ffck_actif'] == 'O') {            $pdf->Image('../img/logoKPI-small.jpg', 84, 10, 0, 16, 'jpg', "https://www.kayak-polo.info");            // Logo        } elseif ($arrayCompetition['Logo_actif'] == 'O' && isset($visuels['logo'])) {            $img = redimImage($visuels['logo'], 210, 10, 16, 'C');            $pdf->Image($img['image'], $img['positionX'], 8, 0, $img['newHauteur']);        }        // Sponsor        if ($arrayCompetition['Sponsor_actif'] == 'O' && isset($visuels['sponsor'])) {            $img = redimImage($visuels['sponsor'], 210, 10, 16, 'C');            $pdf->Image($img['image'], $img['positionX'], 267, 0, $img['newHauteur']);        }        // titre        $pdf->Ln(22);        $pdf->SetFont('Arial', 'B', 14);        if ($arrayCompetition['Titre_actif'] == 'O') {            $pdf->Cell(190, 5, $arrayCompetition['Libelle'], 0, 1, 'C');        } else {            $pdf->Cell(190, 5, $arrayCompetition['Soustitre'], 0, 1, 'C');        }//		$pdf->Ln(4);        if ($arrayCompetition['Soustitre2'] != '') {            $pdf->Cell(190, 5, $arrayCompetition['Soustitre2'], 0, 1, 'C');        }        $pdf->Ln(4);        $pdf->SetFont('Arial', 'BI', 10);        $pdf->Cell(190, 5, $lang['CLASSEMENT_PAR_PHASE'] . ' ' . $lang['PROVISOIRE'], 0, 0, 'C');        $pdf->Ln(4);        // données        $myBdd = new MyBdd();        $sql = "Select a.Id, a.Libelle, a.Code_club, ";        $sql .= "b.Id_journee, b.Clt, b.Pts, b.J, b.G, b.N, b.P, b.F, b.Plus, b.Moins, b.Diff, b.PtsNiveau, b.CltNiveau, ";        $sql .= "c.Phase, c.Niveau, c.Lieu, ";        $sql .= "IF(LEFT(c.Phase, 5) = 'Group' OR LEFT(c.Phase, 5) = 'Poule', c.Phase, 'Z') typePhase ";        $sql .= "From gickp_Competitions_Equipes a, ";        $sql .= "gickp_Competitions_Equipes_Journee b Join gickp_Journees c On (b.Id_journee = c.Id) ";        $sql .= "Where a.Id = b.Id ";        $sql .= "And c.Code_competition = '";        $sql .= $codeCompet;        $sql .= "' And c.Code_saison = '";        $sql .= utyGetSaison();        $sql .= "' Order By typePhase ASC, c.Niveau, c.Phase Asc, c.Date_debut Asc, c.Lieu ASC, b.Clt Asc, b.Diff Desc, b.Plus Desc ";        $result = mysql_query($sql, $myBdd->m_link) or die("Erreur Load");        $num_results = mysql_num_rows($result);        $idJournee = 0;        for ($i = 0; $i < $num_results; $i++) {            $row = mysql_fetch_array($result);            if (stristr($row['Phase'], 'group') === FALSE && stristr($row['Phase'], 'poule') === FALSE) {                if ($row['Id_journee'] != $idJournee) {                    $idJournee = $row['Id_journee'];                    $pdf->Ln(5);                    $pdf->SetFont('Arial', 'BI', 10);                    $pdf->Cell(190, 5, $row['Phase'], 0, 1, 'C');                    $pdf->SetFont('Arial', 'B', 9);                    $sql2 = "Select m.ScoreA, m.ScoreB, ce1.Libelle EquipeA, ce2.Libelle EquipeB ";                    $sql2 .= "From gickp_Matchs m left outer join gickp_Competitions_Equipes ce1 on (m.Id_equipeA = ce1.Id) left outer join gickp_Competitions_Equipes ce2 on (m.Id_equipeB = ce2.Id) ";                    $sql2 .= "Where m.Id_journee = " . $row['Id_journee'];                    $result2 = mysql_query($sql2, $myBdd->m_link) or die("Erreur Load 2<br>" . $sql2);                    $num_results2 = mysql_num_rows($result2);                    for ($j = 0; $j < $num_results2; $j++) {                        $row2 = mysql_fetch_array($result2);                        if ($row2['ScoreA'] > $row2['ScoreB']) {                            $pdf->SetFont('Arial', 'B', 9);                        } else {                            $pdf->SetFont('Arial', '', 9);                        }                        $pdf->Cell(89, 4, $row2['EquipeA'], 0, 0, 'R');                        $pdf->Cell(5, 4, $row2['ScoreA'], 0, 0, 'C');                        $pdf->SetFont('Arial', '', 9);                        $pdf->Cell(2, 4, '-', 0, 0, 'C');                        if ($row2['ScoreA'] < $row2['ScoreB']) {                            $pdf->SetFont('Arial', 'B', 9);                        } else {                            $pdf->SetFont('Arial', '', 9);                        }                        $pdf->Cell(5, 4, $row2['ScoreB'], 0, 0, 'C');                        $pdf->Cell(89, 4, $row2['EquipeB'], 0, 1, 'L');                    }                }            } else {                $idEquipe = $row['Id'];                if ($row['Id_journee'] != $idJournee) {                    $idJournee = $row['Id_journee'];                    $pdf->Ln(5);                    if ($arrayCompetition['Points'] == '4-2-1-0') {                        $pdf->Cell(26, 4, '', 0, 0, 'C');                    } else {                        $pdf->Cell(30, 4, '', 0, 0, 'C');                    }                    $pdf->SetFont('Arial', 'BI', 10);                    $pdf->Cell(61, 4, $row['Phase'], 'B', 0, 'C'); //     "JOURNEE ".$codeCompet.'/'.$idJournee.'/'.                    $pdf->SetFont('Arial', 'BI', 9);                    $pdf->Cell(8, 4, "Pts", 'B', 0, 'C');                    $pdf->Cell(7, 4, $lang['Joue'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $lang['G'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $lang['N'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $lang['P'], 'B', 0, 'C');                    if ($arrayCompetition['Points'] == '4-2-1-0') {                        $pdf->Cell(7, 4, $lang['F'], 'B', 0, 'C');                    }                    $pdf->Cell(8, 4, "+", 'B', 0, 'C');                    $pdf->Cell(8, 4, "-", 'B', 0, 'C');                    $pdf->Cell(8, 4, "+/-", 'B', 1, 'C');                }                $pts = $row['Pts'];                $len = strlen($pts);                if ($len > 2) {                    if (substr($pts, $len - 2, 2) == '00') {                        $pts = substr($pts, 0, $len - 2);                    } else {                        $pts = substr($pts, 0, $len - 2) . '.' . substr($pts, $len - 2, 2);                    }                }                if ($row['J'] != '0') {                    $pdf->SetFont('Arial', '', 9);                    if ($arrayCompetition['Points'] == '4-2-1-0') {                        $pdf->Cell(26, 4, '', 0, 0, 'C');                    } else {                        $pdf->Cell(30, 4, '', 0, 0, 'C');                    }                    $pdf->Cell(61, 4, $row['Clt'] . '. ' . $row['Libelle'], 'B', 0, 'L');                    $pdf->Cell(8, 4, $pts, 'B', 0, 'C');                    $pdf->Cell(7, 4, $row['J'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $row['G'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $row['N'], 'B', 0, 'C');                    $pdf->Cell(7, 4, $row['P'], 'B', 0, 'C');                    if ($arrayCompetition['Points'] == '4-2-1-0') {                        $pdf->Cell(7, 4, $row['F'], 'B', 0, 'C');                    }                    $pdf->Cell(8, 4, $row['Plus'], 'B', 0, 'C');                    $pdf->Cell(8, 4, $row['Moins'], 'B', 0, 'C');                    $pdf->Cell(8, 4, $row['Diff'], 'B', 1, 'C');                }            }        }        $pdf->SetFont('Arial', 'I', 8);        if ($arrayCompetition['Sponsor_actif'] == 'O' && isset($visuels['sponsor'])) {            $pdf->SetXY(165, 263);        } else {            $pdf->SetXY(165, 270);        }        if ($lang == $langue['en']) {            $pdf->Write(4, date('Y-m-d H:i'));        } else {            $pdf->Write(4, date('d/m/Y à H:i'));        }        $pdf->Output('Classement par phase ' . $codeCompet . '.pdf', 'I');    }}$page = new FeuilleCltNiveauPhase();
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Performance test</title>
    <style type="text/css">
        div {
            /* border: 1px dotted red; */
        }
        .buttons {
            width: fit-content;
            height: 30px;
        }

        .container {
            display: flex;
            margin-top: 5px;
        }

        .column {
            flex: 1;
            padding: 10px;
        }

        #results {
            height: 350px;
            overflow: scroll;
            border: 1px solid grey;
            font-family: 'Courier New', Courier, monospace;
            font-size: small;
        }

        .spinner {
            float:inline-end;
            margin-left: 5px;
            width: 20px;
            height: 20px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            visibility: hidden;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #webSocketTestId {
            visibility: visible;
        }
    </style>
</head>
<body>
    <h1>Performance test to join KPI host</h1>
    <div class="buttons">
        <input type="text" id="firstNameId" placeholder="Your firstname">
        <button id="latencyTestButton" onclick="testLatency()">Latency test</button>
        <button id="speedTestButton" onclick="testSpeed()">Speed test</button>
        <button id="webSocketTestButton" onclick="webSocketTest()">WebSocket connection</button>
        <div id="spinner" class="spinner"></div>
    </div>
    <div class="container">
        <div class="column" id="results"></div>
        <div class="column" id="targetDivId"></div>
    </div>
    <button onclick="clearDiv()">Clear</button>

    <script>
        const latencyTestButton = document.getElementById('latencyTestButton')
        const speedTestButton = document.getElementById('speedTestButton')
        const webSocketTestButton = document.getElementById('webSocketTestButton')
        const spinner = document.getElementById('spinner')

        function clearDiv() {
            document.getElementById('results').innerHTML = ``
        }
        function testLatency() {
            const start = performance.now()
            latencyTestButton.style.visibility = 'hidden'
            spinner.style.visibility = 'visible'
            const timestamp = new Date().getTime()
            fetch(`ping.php?${timestamp}`)
                .then(() => {
                    const end = performance.now()
                    const latency = end - start
                    updateResults(`Latency: ${latency.toFixed(2)} ms`)
                    sendResults(`Latency: ${latency.toFixed(2)} ms`)
                    latencyTestButton.style.visibility = 'visible'
                    spinner.style.visibility = 'hidden'
                })
                .catch(error => {
                    updateResults('Error on latency test')
                    sendResults('Error on latency test')
                    latencyTestButton.style.visibility = 'visible'
                    spinner.style.visibility = 'hidden'
                })
        }

        function testSpeed() {
            const fileSize = 4.03 * 1024 * 1024 // 4 MB
            const start = performance.now()
            speedTestButton.style.visibility = 'hidden'
            spinner.style.visibility = 'visible'
            const timestamp = new Date().getTime()
            fetch(`dequing.png?${timestamp}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP Error! status: ${response.status}`)
                    }
                    return response.blob()
                })
                .then(blob => {
                    const end = performance.now()
                    const durationInSeconds = (end - start) / 1000
                    const speedMbps = (fileSize * 8 / durationInSeconds / 1000000).toFixed(2)
                    updateResults(`Speed: ${speedMbps} Mbps`)
                    sendResults(`Speed: ${speedMbps} Mbps`)

                    const objectURL = URL.createObjectURL(blob)
                    const imgElement = document.createElement('img')
                    imgElement.src = objectURL
                    imgElement.width = 200
                    const targetDiv = document.getElementById('targetDivId')
                    targetDiv.appendChild(imgElement)
                    speedTestButton.style.visibility = 'visible'
                    spinner.style.visibility = 'hidden'
                })
                .catch(error => {
                    updateResults('Speed test error:', error)
                    sendResults('Speed test error:', error)
                    speedTestButton.style.visibility = 'visible'
                    spinner.style.visibility = 'hidden'
                })
        }

        function updateResults(message) {
            document.getElementById('results').innerHTML += `${message}<br>`
            document.getElementById('results').scrollTop = document.getElementById('results').scrollHeight;
        }

        function sendResults(message) {
            let firstname = document.getElementById('firstNameId')
            name = firstname.value.length > 0 ? ' (' + firstname.value + ')' : ' (anonymous)'
            fetch('collect-results.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: message + name
            })
            .then(response => response.json())
            .then(data => updateResults('Sending result: ' + JSON.stringify(data) + '<br>Thank you ' + firstname.value + '<br>'))
            .catch(error => updateResults(`Error sending result: ` + error))
        }

        let socket
        let socketMessage
        function webSocketTest() {
            const start = performance.now()
            socket = new WebSocket('wss://kp.agilsport.fr:443')

            socket.onopen = function(event) {
                const end = performance.now()
                const connectionDuration = end - start
                document.getElementById('webSocketTestButton').style.visibility = 'hidden'
                spinner.style.visibility = 'visible'
                socketMessage = 'WebSocket connection established in ' + connectionDuration + ' ms'
                updateResults(socketMessage)
                socket.send(JSON.stringify({"p":"194_1","connect":"writer"}))
                let compteur = 0
                const intervalle = setInterval(() => {
                    webSocketSend('Test message ' + compteur)
                    compteur++
                    if (compteur >= 5) {
                        clearInterval(intervalle)
                        if (socket.readyState === WebSocket.OPEN) {
                            socket.close()
                        }
                    }
                }, 1000)
            }

            socket.onmessage = function(event) {
                updateResults('Message received from server:', event.data);
            }

            socket.onerror = function(error) {
                const end = performance.now()
                const connectionDuration = end - start
                document.getElementById('webSocketTestButton').style.visibility = 'visible'
                spinner.style.visibility = 'hidden'
                updateResults('WebSocket error in ' + connectionDuration + ' ms')
                sendResults('WebSocket error in ' + connectionDuration + ' ms')
                console.log(error)
            }

            socket.onclose = function(event) {
                document.getElementById('webSocketTestButton').style.visibility = 'visible'
                spinner.style.visibility = 'hidden'
                updateResults('WebSocket connection closed')
                if (socketMessage !== undefined) {
                    sendResults(socketMessage)
                }
            }
        }

        function webSocketSend(message) {
            // socket.send('Test message ' + message)
            const obj = {
                p: '194_1',
                t: 'scoreA',
                v: message
                // v: { time: '10:00', run: 'waiting' }
            }
            const obj2 = {"prolongation":false,"currentPeriod":2,"nbPeriodInGame":4}
            // console.log(JSON.stringify(obj), JSON.stringify(obj2))
            socket.send(JSON.stringify(obj))
            updateResults('Test message ' + message)
        }

    </script>
</body>
</html>
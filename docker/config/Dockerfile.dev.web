ARG BASE_IMAGE_PHP
ARG USER_ID
ARG GROUP_ID

FROM ${BASE_IMAGE_PHP}

# Install required packages and PHP extensions for development
# Includes mPDF dependencies: gd (image processing), zip (file compression)
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    libonig-dev \
    mailutils \
    msmtp \
    gnupg \
    nano \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libzip-dev \
    zip \
    unzip \
    git \
    locales \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install pdo pdo_mysql mbstring mysqli gd zip \
    && docker-php-ext-enable mysqli \
    && a2enmod headers \
    && a2enmod expires \
    && a2enmod rewrite \
    && service apache2 restart \
    && sed -i '/fr_FR.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /var/run/apache2/apache2.pid \
    && mv "$PHP_INI_DIR/php.ini-development" "$PHP_INI_DIR/php.ini" \
    && apt-get remove -y exim4 exim4-base exim4-config exim4-daemon-light || true \
    && echo "sendmail_path = /usr/bin/msmtp -t" > /usr/local/etc/php/conf.d/sendmail.ini

# Copy PHP error logging configuration
COPY php-error-logging.ini /usr/local/etc/php/conf.d/

# Copy Apache API2 configuration
COPY apache-api2.conf /etc/apache2/conf-available/
RUN chmod 644 /etc/apache2/conf-available/apache-api2.conf && a2enconf apache-api2

# Optional: create a dummy user to avoid 'Failed to get user name for uid 1000'
ARG USER_ID
RUN useradd -u ${USER_ID:-1000} -m dockeruser || true

# Install Composer (multi-stage copy for minimal footprint)
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer
